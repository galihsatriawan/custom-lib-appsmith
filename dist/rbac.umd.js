!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).rbac=t()}(this,(function(){"use strict";return{state:{env:"dev",storeValue:async()=>{},navigateTo:async()=>{},clearStore:async()=>{},showAlert:async()=>{}},field:{token:"tokens"},errorConst:{unexpectedError:{code:"unexpectedError",message:"Unexpected error"},unauthorizedUser:{code:"EVAC4007",message:"unauthorized user"},forbiddenAction:{code:"EVAC6007",message:"forbidden action"},tokenExpired:{code:"EVAC4008",message:"token has expired"}},config:{env:{dev:{host:"https://evm-rbac.staging.evermosa2z.com"}},path:{user:{login:"/v1/user/login",refreshToken:"/v1/user/refresh",logout:"/v1/user/logout",register:"/v1/user/register"},subject:{authorize:"/v1/subject/authorize",refreshToken:"/v1/subject/refresh",logout:"/v1/subject/logout"}}},setState(e,t,r,s,o){this.state.env=e,this.state.storeValue=t,this.state.navigateTo=r,this.state.clearStore=s,this.state.showAlert=o},decodeToken:e=>jsonwebtoken.decode(e),wrapResult:(e,t=!1)=>t?{code:e.errorCode,error:e.error}:{data:e},newError:(e,t)=>({errorCode:e,error:t}),composeHeaderAuthorization:e=>({"Content-Type":"application/json",Accept:"application/json",Authorization:"Bearer "+e}),async login(e,t){let r=this.config.env[this.state.env].host+this.config.path.user.login;return await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,password:t})}).then((async e=>{let t=await e.json();return 200===t.statusCode?(await this.state.storeValue(this.field.token,t.data),this.wrapResult(t.data)):this.wrapResult(this.newError(t.errorCode,t.error),!0)})).catch((e=>this.wrapResult(this.newError(this.errorConst.unexpectedError,e.message),!0)))},async register(e,t,r,s){let o=this.config.env[this.state.env].host+this.config.path.user.register;return await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,password:t,appName:r,merchantCode:s})}).then((async e=>{let t=await e.json();return 201===t.statusCode?this.wrapResult(t.data):this.wrapResult(this.newError(t.errorCode,t.error),!0)})).catch((e=>this.wrapResult(this.newError(this.errorConst.unexpectedError,e.message),!0)))},async authorizePage(e,t,r){const s=r.tokens.subjectAccessToken.filter((t=>t.object===e));if(0===s.length)return this.wrapResult(this.newError(this.errorConst.forbiddenAction.code,this.errorConst.forbiddenAction.message),!0);let o=s[0].accessToken;if(t!=this.decodeToken(o).objectId)return this.wrapResult(this.newError(this.errorConst.unauthorizedUser.code,this.errorConst.unauthorizedUser.message),!0);try{let e=this.config.env[this.state.env].host+this.config.path.subject.authorize;const t=await fetch(e,{method:"POST",headers:this.composeHeaderAuthorization(o)});let r=await t.json();return 200!=r.statusCode?this.wrapResult(this.newError(r.errorCode,r.error),!0):this.wrapResult(!0)}catch(e){return this.wrapResult(this.newError(this.errorConst.unexpectedError,e.message),!0)}},async logout(e){try{let t=this.config.env[this.state.env].host+this.config.path.user.logout;const r=await fetch(t,{method:"POST",headers:this.composeHeaderAuthorization(e.tokens.accessToken)});let s=await r.json();return 200!=s.statusCode?this.wrapResult(this.newError(s.errorCode,s.error),!0):(await this.state.clearStore(this.field.token),this.wrapResult("success"))}catch(e){return this.wrapResult(this.newError(this.errorConst.unexpectedError,e.message),!0)}},async refreshToken(e){try{let t=this.config.env[this.state.env].host+this.config.path.user.refreshToken;const r=await fetch(t,{method:"POST",headers:this.composeHeaderAuthorization(e.tokens.refreshToken)});let s=await r.json();return 200===s.statusCode?(e.tokens.accessToken=s.data.accessToken,e.tokens.refreshToken=s.data.refreshToken,await this.state.storeValue(this.field.token,tokens),this.wrapResult(s.data)):this.wrapResult(this.newError(s.errorCode,s.error),!0)}catch(e){return this.wrapResult(this.newError(this.errorConst.unexpectedError,e.message),!0)}},async subjectLogout(e){try{let t=this.config.env[this.state.env].host+this.config.path.subject.logout;const r=await fetch(t,{method:"POST",headers:this.composeHeaderAuthorization(e)});let s=await r.json();return 200!=s.statusCode?this.wrapResult(this.newError(s.errorCode,s.error),!0):this.wrapResult(!0)}catch(e){return this.wrapResult(this.newError(this.errorConst.unexpectedError,e.message),!0)}},async subjectRefreshToken(e,t){try{let r=this.config.env[this.state.env].host+this.config.path.subject.refreshToken,s=-1;for(let r=0;r<t.tokens.subjectAccessToken;r++)if(t.tokens.subjectAccessToken[r].refreshToken==e){s=r;break}const o=await fetch(r,{method:"POST",headers:this.composeHeaderAuthorization(e)});let n=await o.json();return 200===n.statusCode?(-1!=s?(t.tokens.subjectAccessToken[s].accessToken=n.data.accessToken,t.tokens.subjectAccessToken[s].refreshToken=n.data.refreshToken):t.tokens.subjectAccessToken.push(n.data),await this.state.storeValue(this.field.token,tokens),this.wrapResult(n.data)):this.wrapResult(this.newError(n.errorCode,n.error),!0)}catch(e){return this.wrapResult(this.newError(this.errorConst.unexpectedError,e.message),!0)}}}}));
