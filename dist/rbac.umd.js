!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).rbac=t()}(this,(function(){"use strict";return{state:{hasSetState:!1,env:"dev",pages:void 0,useRefreshToken:!1,storeValue:async()=>{},navigateTo:async()=>{},clearStore:async()=>{},showAlert:async()=>{}},field:{token:"tokens",userInfo:"userInfo",authorizedPage:"authorizedPages"},errorConst:{unexpectedError:{code:"unexpectedError",message:"Unexpected error"},unauthorizedUser:{code:"EVAC4007",message:"unauthorized user"},forbiddenAction:{code:"EVAC6007",message:"forbidden action"},requiredPageData:{code:"EVAC6008",message:"required page data"},requiredSetStateData:{code:"EVAC6009",message:"state data is required to be set"},tokenExpired:{code:"EVAC4008",message:"token has expired"}},config:{env:{dev:{host:"https://api-fb.evermosa2z.com/rbac-fb"}},path:{user:{login:"/v1/user/login",refreshToken:"/v1/user/refresh",logout:"/v1/user/logout",register:"/v1/user/register",info:"/v1/user/info"},subject:{authorize:"/v1/subject/authorize",refreshToken:"/v1/subject/refresh",logout:"/v1/subject/logout",assignSubject:"/v1/subject/role",unassignSubject:"/v1/subject/role",list:"/v1/subject/list"},application:{authorize:"/v1/application/{id}/oauth/authorize"}}},setState(e,t,r,s,o,a=!1){return this.state.hasSetState=!0,this.state.env=e,this.state.storeValue=t,this.state.navigateTo=r,this.state.clearStore=s,this.state.showAlert=o,this.state.useRefreshToken=a,this},setPages(e){return this.state.pages=e,this},setUseRefreshToken(e){return this.state.useRefreshToken=e,this},decodeToken:e=>jsonwebtoken.decode(e),checkPrerequisiteFunction(e={needPageData:!1,needToken:!1}){return this.state.hasSetState?null==this.state.pages&&void 0!==e.needPageData&&e.needPageData?this.wrapResult(this.newError(this.errorConst.requiredPageData.code,this.errorConst.requiredPageData.message),!0):needToken&&!appsmith.store.token?this.wrapResult(this.newError(this.errorConst.tokenExpired.code,this.errorConst.tokenExpired.message),!0):this.wrapResult(!0):this.wrapResult(this.newError(this.errorConst.requiredSetStateData.code,this.errorConst.requiredSetStateData.message),!0)},wrapResult:(e,t=!1)=>t?{code:e.errorCode,error:e.error}:{data:e},newError:(e,t)=>({errorCode:e,error:t}),composeHeaderAuthorization:e=>({"Content-Type":"application/json",Accept:"application/json",Authorization:"Bearer "+e}),getFirstAuthorizedPage(){for(const e in appsmith.store.authorizedPages){return appsmith.store.authorizedPages[e]}return this.wrapResult(this.newError(this.errorConst.forbiddenAction.code,this.errorConst.forbiddenAction.message),!0)},async setAuthorizedPage(e){let t={};if(null==e.subjectAccessToken)return await this.state.storeValue(this.field.authorizedPage,t),t;for(const r in e.subjectAccessToken){let s=e.subjectAccessToken[r];if(this.state.pages[s.object]){let e=this.state.pages[s.object],r=this.decodeToken(s.accessToken);e.id==r.objectId&&(t[e.code]=e)}}return await this.state.storeValue(this.field.authorizedPage,t),t},async login(e,t){let r=this.checkPrerequisiteFunction({needPageData:!0});if(r.error)return r;let s=this.config.env[this.state.env].host+this.config.path.user.login;return await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,password:t})}).then((async e=>{let t=await e.json();return 200===t.statusCode?(await this.state.storeValue(this.field.token,t.data),await this.setAuthorizedPage(t.data),await this.getUserInfo(),this.wrapResult(t.data)):this.wrapResult(this.newError(t.errorCode,t.error),!0)})).catch((e=>this.wrapResult(this.newError(this.errorConst.unexpectedError,e.message),!0)))},async register(e,t,r,s){let o=this.checkPrerequisiteFunction();if(o.error)return o;let a=this.config.env[this.state.env].host+this.config.path.user.register;return await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,password:t,appName:r,merchantCode:s})}).then((async e=>{let t=await e.json();return 201===t.statusCode?this.wrapResult(t.data):this.wrapResult(this.newError(t.errorCode,t.error),!0)})).catch((e=>this.wrapResult(this.newError(this.errorConst.unexpectedError,e.message),!0)))},async authorizePage(e,t){let r=this.checkPrerequisiteFunction({needToken:!0});if(r.error)return r;const s=appsmith.store.tokens.subjectAccessToken.filter((r=>{let s=this.decodeToken(r.accessToken);return r.object===e&&t==s.objectId}));if(0===s.length)return this.wrapResult(this.newError(this.errorConst.forbiddenAction.code,this.errorConst.forbiddenAction.message),!0);let o=s[0].accessToken,a=s[0].refreshToken;try{let e=this.config.env[this.state.env].host+this.config.path.subject.authorize;const t=await fetch(e,{method:"POST",headers:this.composeHeaderAuthorization(o)});let r=await t.json();if(200!=r.statusCode){if(this.state.useRefreshToken&&r.errorCode==this.errorConst.tokenExpired.code){let t=await this.subjectRefreshToken(a);if(t.error)return t.code==this.errorConst.tokenExpired.code&&await this.state.clearStore(this.field.token),this.wrapResult(this.newError(t.code,t.error),!0);const r=await fetch(e,{method:"POST",headers:this.composeHeaderAuthorization(t.data.accessToken)});let s=await r.json();return 200!=s.statusCode?this.wrapResult(this.newError(s.errorCode,s.error),!0):this.wrapResult(!0)}return r.errorCode==this.errorConst.tokenExpired.code&&await this.state.clearStore(this.field.token),this.wrapResult(this.newError(r.errorCode,r.error),!0)}return this.wrapResult(!0)}catch(e){return this.wrapResult(this.newError(this.errorConst.unexpectedError,e.message),!0)}},async logout(){let e=this.checkPrerequisiteFunction();if(e.error)return e;if(!appsmith.store.tokens)return this.wrapResult("success");try{let e=this.config.env[this.state.env].host+this.config.path.user.logout;const t=await fetch(e,{method:"POST",headers:this.composeHeaderAuthorization(appsmith.store.tokens.accessToken)});let r=await t.json();return 200!=r.statusCode?(await this.state.clearStore(this.field.token),await this.state.clearStore(this.field.userInfo),this.wrapResult(this.newError(r.errorCode,r.error),!0)):(await this.state.clearStore(this.field.token),await this.state.clearStore(this.field.userInfo),this.wrapResult("success"))}catch(e){return this.wrapResult(this.newError(this.errorConst.unexpectedError,e.message),!0)}},async getUserInfo(){let e=this.checkPrerequisiteFunction({needToken:!0});if(e.error)return e;try{let e=this.config.env[this.state.env].host+this.config.path.user.info;const t=await fetch(e,{method:"GET",headers:this.composeHeaderAuthorization(appsmith.store.tokens.accessToken)});let r=await t.json();return 200!=r.statusCode?this.wrapResult(this.newError(r.errorCode,r.error),!0):(await storeValue(this.field.userInfo,r.data),this.wrapResult(r.data))}catch(e){return this.wrapResult(this.newError(this.errorConst.unexpectedError,e.message),!0)}},async getOauthPage(e,t){let r=this.checkPrerequisiteFunction({needPageData:!0});if(r.error)return r;try{appsmith.store.userInfo||await this.getUserInfo();let r=this.config.path.application.authorize.replace("{id}",appsmith.store.userInfo.currentLoggedInfo.appId),s=this.config.env[this.state.env].host+r;const o=await fetch(s,{method:"POST",headers:this.composeHeaderAuthorization(appsmith.store.tokens.accessToken),body:JSON.stringify({provider:e,redirectUrl:t})});let a=await o.json();return 200!=a.statusCode?this.wrapResult(this.newError(a.errorCode,a.error),!0):this.wrapResult(a.data)}catch(e){return this.wrapResult(this.newError(this.errorConst.unexpectedError,e.message),!0)}},async processOauthCallback(){let e=this.checkPrerequisiteFunction({needPageData:!0});if(e.error)return e;try{if(!appsmith.URL.queryParams.token&&!appsmith.URL.queryParams.error)return;if(appsmith.URL.queryParams.error){let e=btoa(appsmith.URL.queryParams.error);const t=JSON.parse(e);return this.wrapResult(this.newError(t.errorCode,t.error),!0)}let e=btoa(appsmith.URL.queryParams.token);const t=JSON.parse(e);return await storeValue(this.field.token,t),await this.getUserInfo(),this.wrapResult(t)}catch(e){return this.wrapResult(this.newError(this.errorConst.unexpectedError,e.message),!0)}},async refreshToken(){let e=this.checkPrerequisiteFunction({needToken:!0});if(e.error)return e;try{let e=this.config.env[this.state.env].host+this.config.path.user.refreshToken;const t=await fetch(e,{method:"POST",headers:this.composeHeaderAuthorization(appsmith.store.tokens.refreshToken)});let r=await t.json(),s=appsmith.store.tokens;return 200===r.statusCode?(s.accessToken=r.data.accessToken,s.refreshToken=r.data.refreshToken,await this.state.storeValue(this.field.token,s),this.wrapResult(r.data)):this.wrapResult(this.newError(r.errorCode,r.error),!0)}catch(e){return this.wrapResult(this.newError(this.errorConst.unexpectedError,e.message),!0)}},async subjectLogout(e){let t=this.checkPrerequisiteFunction({needToken:!0});if(t.error)return t;try{let t=this.config.env[this.state.env].host+this.config.path.subject.logout;const r=await fetch(t,{method:"POST",headers:this.composeHeaderAuthorization(e)});let s=await r.json();return 200!=s.statusCode?this.wrapResult(this.newError(s.errorCode,s.error),!0):this.wrapResult(!0)}catch(e){return this.wrapResult(this.newError(this.errorConst.unexpectedError,e.message),!0)}},async subjectRefreshToken(e){let t=this.checkPrerequisiteFunction({needToken:!0});if(t.error)return t;try{let t=this.config.env[this.state.env].host+this.config.path.subject.refreshToken,r=-1,s=appsmith.store.tokens;for(let t=0;t<s.subjectAccessToken.length;t++)if(s.subjectAccessToken[t].refreshToken==e){r=t;break}const o=await fetch(t,{method:"POST",headers:this.composeHeaderAuthorization(e)});let a=await o.json();return 200===a.statusCode?(-1!=r?(s.subjectAccessToken[r].accessToken=a.data.accessToken,s.subjectAccessToken[r].refreshToken=a.data.refreshToken):s.subjectAccessToken.push(a.data),await this.state.storeValue(this.field.token,s),this.wrapResult(a.data)):this.wrapResult(this.newError(a.errorCode,a.error),!0)}catch(e){return this.wrapResult(this.newError(this.errorConst.unexpectedError,e.message),!0)}},async subjectList(e={name:"",code:"",sortBy:"",sortDirection:"",page:"",size:""}){let t=this.checkPrerequisiteFunction({needToken:!0});if(t.error)return t;try{let t=new URL(this.config.env[this.state.env].host+this.config.path.subject.list);const r=new URLSearchParams({name:e.name,code:e.code,sortBy:e.sortBy,sortDirection:e.sortDirection,page:e.page,size:e.size});t.search=r;const s=await fetch(t.toString(),{method:"GET",headers:this.composeHeaderAuthorization(appsmith.store.tokens.accessToken)});let o=await s.json();return 200!=o.statusCode?this.wrapResult(this.newError(o.errorCode,o.error),!0):this.wrapResult(o.data)}catch(e){return this.wrapResult(this.newError(this.errorConst.unexpectedError,e.message),!0)}},async assignSubject(e=[]){let t=this.checkPrerequisiteFunction({needToken:!0});if(t.error)return t;try{let t=new URL(this.config.env[this.state.env].host+this.config.path.subject.assignSubject);const r=await fetch(t.toString(),{method:"POST",headers:this.composeHeaderAuthorization(appsmith.store.tokens.accessToken),body:JSON.stringify(e)});let s=await r.json();return 200!=s.statusCode?this.wrapResult(this.newError(s.errorCode,s.error),!0):this.wrapResult(s.data)}catch(e){return this.wrapResult(this.newError(this.errorConst.unexpectedError,e.message),!0)}},async unassignSubject(e=[]){let t=this.checkPrerequisiteFunction({needToken:!0});if(t.error)return t;try{let t=new URL(this.config.env[this.state.env].host+this.config.path.subject.unassignSubject);const r=await fetch(t.toString(),{method:"DELETE",headers:this.composeHeaderAuthorization(appsmith.store.tokens.accessToken),body:JSON.stringify(e)});let s=await r.json();return 200!=s.statusCode?this.wrapResult(this.newError(s.errorCode,s.error),!0):this.wrapResult(s.data)}catch(e){return this.wrapResult(this.newError(this.errorConst.unexpectedError,e.message),!0)}}}}));
