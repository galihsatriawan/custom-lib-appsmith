!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).rbac=t()}(this,(function(){"use strict";return{state:{env:"dev",useRefreshToken:!1,storeValue:async()=>{},navigateTo:async()=>{},clearStore:async()=>{},showAlert:async()=>{}},field:{token:"tokens",authorizedPage:"authorizedPages"},errorConst:{unexpectedError:{code:"unexpectedError",message:"Unexpected error"},unauthorizedUser:{code:"EVAC4007",message:"unauthorized user"},forbiddenAction:{code:"EVAC6007",message:"forbidden action"},tokenExpired:{code:"EVAC4008",message:"token has expired"}},config:{env:{dev:{host:"https://evm-rbac.staging.evermosa2z.com"}},path:{user:{login:"/v1/user/login",refreshToken:"/v1/user/refresh",logout:"/v1/user/logout",register:"/v1/user/register"},subject:{authorize:"/v1/subject/authorize",refreshToken:"/v1/subject/refresh",logout:"/v1/subject/logout",assignSubject:"/v1/subject/role",unassignSubject:"/v1/subject/role",list:"/v1/subject/list"}}},setState(e,t,s,r,o,a=!1){this.state.env=e,this.state.storeValue=t,this.state.navigateTo=s,this.state.clearStore=r,this.state.showAlert=o,this.state.useRefreshToken=a},decodeToken:e=>jsonwebtoken.decode(e),wrapResult:(e,t=!1)=>t?{code:e.errorCode,error:e.error}:{data:e},newError:(e,t)=>({errorCode:e,error:t}),composeHeaderAuthorization:e=>({"Content-Type":"application/json",Accept:"application/json",Authorization:"Bearer "+e}),getFirstAuthorizedPage(){for(const e in appsmith.store.authorizedPages){return appsmith.store.authorizedPages[e]}return this.wrapResult(this.newError(this.errorConst.forbiddenAction.code,this.errorConst.forbiddenAction.message),!0)},async setAuthorizedPage(e){let t={};for(const s in e.subjectAccessToken){let r=e.subjectAccessToken[s];if(this.pages[r.object]){let e=this.pages[r.object],s=this.decodeToken(r.accessToken);e.id==s.objectId&&(t[e.code]=e)}}return await this.state.storeValue(this.field.authorizedPage,t),t},async login(e,t){let s=this.config.env[this.state.env].host+this.config.path.user.login;return await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,password:t})}).then((async e=>{let t=await e.json();return 200===t.statusCode?(await this.state.storeValue(this.field.token,t.data),await this.setAuthorizedPage(t.data),this.wrapResult(t.data)):this.wrapResult(this.newError(t.errorCode,t.error),!0)})).catch((e=>this.wrapResult(this.newError(this.errorConst.unexpectedError,e.message),!0)))},async register(e,t,s,r){let o=this.config.env[this.state.env].host+this.config.path.user.register;return await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,password:t,appName:s,merchantCode:r})}).then((async e=>{let t=await e.json();return 201===t.statusCode?this.wrapResult(t.data):this.wrapResult(this.newError(t.errorCode,t.error),!0)})).catch((e=>this.wrapResult(this.newError(this.errorConst.unexpectedError,e.message),!0)))},async authorizePage(e,t,s){const r=s.tokens.subjectAccessToken.filter((t=>t.object===e));if(0===r.length)return this.wrapResult(this.newError(this.errorConst.forbiddenAction.code,this.errorConst.forbiddenAction.message),!0);let o=r[0].accessToken,a=r[0].refreshToken;if(t!=this.decodeToken(o).objectId)return this.wrapResult(this.newError(this.errorConst.unauthorizedUser.code,this.errorConst.unauthorizedUser.message),!0);try{let e=this.config.env[this.state.env].host+this.config.path.subject.authorize;const t=await fetch(e,{method:"POST",headers:this.composeHeaderAuthorization(o)});let r=await t.json();if(200!=r.statusCode){if(this.state.useRefreshToken){let e=await this.subjectRefreshToken(a,s);return e.error?this.wrapResult(this.newError(e.code,e.error),!0):this.wrapResult(!0)}return this.wrapResult(this.newError(r.errorCode,r.error),!0)}return this.wrapResult(!0)}catch(e){return this.wrapResult(this.newError(this.errorConst.unexpectedError,e.message),!0)}},async logout(e){try{let t=this.config.env[this.state.env].host+this.config.path.user.logout;const s=await fetch(t,{method:"POST",headers:this.composeHeaderAuthorization(e.tokens.accessToken)});let r=await s.json();return 200!=r.statusCode?this.wrapResult(this.newError(r.errorCode,r.error),!0):(await this.state.clearStore(this.field.token),this.wrapResult("success"))}catch(e){return this.wrapResult(this.newError(this.errorConst.unexpectedError,e.message),!0)}},async refreshToken(e){try{let t=this.config.env[this.state.env].host+this.config.path.user.refreshToken;const s=await fetch(t,{method:"POST",headers:this.composeHeaderAuthorization(e.tokens.refreshToken)});let r=await s.json();return 200===r.statusCode?(e.tokens.accessToken=r.data.accessToken,e.tokens.refreshToken=r.data.refreshToken,await this.state.storeValue(this.field.token,tokens),this.wrapResult(r.data)):this.wrapResult(this.newError(r.errorCode,r.error),!0)}catch(e){return this.wrapResult(this.newError(this.errorConst.unexpectedError,e.message),!0)}},async subjectLogout(e){try{let t=this.config.env[this.state.env].host+this.config.path.subject.logout;const s=await fetch(t,{method:"POST",headers:this.composeHeaderAuthorization(e)});let r=await s.json();return 200!=r.statusCode?this.wrapResult(this.newError(r.errorCode,r.error),!0):this.wrapResult(!0)}catch(e){return this.wrapResult(this.newError(this.errorConst.unexpectedError,e.message),!0)}},async subjectRefreshToken(e,t){try{let s=this.config.env[this.state.env].host+this.config.path.subject.refreshToken,r=-1;for(let s=0;s<t.tokens.subjectAccessToken;s++)if(t.tokens.subjectAccessToken[s].refreshToken==e){r=s;break}const o=await fetch(s,{method:"POST",headers:this.composeHeaderAuthorization(e)});let a=await o.json();return 200===a.statusCode?(-1!=r?(t.tokens.subjectAccessToken[r].accessToken=a.data.accessToken,t.tokens.subjectAccessToken[r].refreshToken=a.data.refreshToken):t.tokens.subjectAccessToken.push(a.data),await this.state.storeValue(this.field.token,t.tokens),this.wrapResult(a.data)):this.wrapResult(this.newError(a.errorCode,a.error),!0)}catch(e){return this.wrapResult(this.newError(this.errorConst.unexpectedError,e.message),!0)}},async subjectList(e,t={name:void 0,code:void 0,sortBy:void 0,sortDirection:void 0,page:void 0,size:void 0}){try{let s=new URL(this.config.env[this.state.env].host+this.config.path.subject.list);const r=new URLSearchParams({name:t.name,code:t.code,sortBy:t.sortBy,sortDirection:t.sortDirection,page:t.page,size:t.size});s.search=r;const o=await fetch(s.toString(),{method:"GET",headers:this.composeHeaderAuthorization(e.tokens.accessToken)});let a=await o.json();return 200!=a.statusCode?this.wrapResult(this.newError(a.errorCode,a.error),!0):this.wrapResult(a.data)}catch(e){return this.wrapResult(this.newError(this.errorConst.unexpectedError,e.message),!0)}},async assignSubject(e,t=[]){try{let s=new URL(this.config.env[this.state.env].host+this.config.path.subject.assignSubject);const r=await fetch(s.toString(),{method:"POST",headers:this.composeHeaderAuthorization(e.tokens.accessToken),body:JSON.stringify(t)});let o=await r.json();return 200!=o.statusCode?this.wrapResult(this.newError(o.errorCode,o.error),!0):this.wrapResult(o.data)}catch(e){return this.wrapResult(this.newError(this.errorConst.unexpectedError,e.message),!0)}},async unassignSubject(e,t=[]){try{let s=new URL(this.config.env[this.state.env].host+this.config.path.subject.unassignSubject);const r=await fetch(s.toString(),{method:"DELETE",headers:this.composeHeaderAuthorization(e.tokens.accessToken),body:JSON.stringify(t)});let o=await r.json();return 200!=o.statusCode?this.wrapResult(this.newError(o.errorCode,o.error),!0):this.wrapResult(o.data)}catch(e){return this.wrapResult(this.newError(this.errorConst.unexpectedError,e.message),!0)}}}}));
